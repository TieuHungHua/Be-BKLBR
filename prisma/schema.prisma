

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://neondb_owner:npg_sSDtRa5Jxi0b@ep-delicate-mouse-a40czuxz-pooler.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
}

// Enums
enum UserRole {
  student
  admin
  lecturer
}

enum BorrowStatus {
  active
  returned
  overdue
}

enum InteractionType {
  like
  comment
}

enum EventType {
  borrow
  return
  like
  comment
  redeem
}

enum PointReason {
  borrow
  return_on_time
  return_late
  like
  comment
  redeem
}

enum RedeemStatus {
  pending
  approved
  delivered
}

// Models
model User {
  id            String   @id @default(uuid())
  username      String   @unique
  password      String   // Hashed password
  email         String?  @unique
  phone         String?  @unique
  studentId     String?  @map("student_id") // Mã sinh viên (chỉ cho student)
  displayName   String   @map("display_name")
  avatar        String?
  classMajor    String?  @map("class_major")
  role          UserRole @default(student)
  
  // Counters (cached/aggregated)
  totalBorrowed Int      @default(0) @map("total_borrowed")
  totalReturned Int      @default(0) @map("total_returned")
  totalLikes    Int      @default(0) @map("total_likes")
  totalComments Int      @default(0) @map("total_comments")
  activityScore Int      @default(0) @map("activity_score")
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  borrows            Borrow[]
  interactions       Interaction[]
  pointTransactions  PointTransaction[]
  redeems            Redeem[]
  activities         Activity[]
  
  @@map("users")
  @@index([role])
}

model Book {
  id            String   @id @default(uuid())
  title         String
  author        String
  categories    String[] @default([])
  coverImage    String?  @map("cover_image") // URL ảnh bìa từ Cloudinary
  availableCopies Int    @default(0) @map("available_copies")
  
  // Counters
  likeCount     Int      @default(0) @map("like_count")
  commentCount  Int      @default(0) @map("comment_count")
  borrowCount   Int      @default(0) @map("borrow_count")
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  borrows       Borrow[]
  interactions  Interaction[]
  activities    Activity[]
  
  @@map("books")
  @@index([title])
  @@index([author])
}

model Borrow {
  id          String       @id @default(uuid())
  userId      String       @map("user_id")
  bookId      String       @map("book_id")
  borrowedAt  DateTime     @default(now()) @map("borrowed_at")
  dueAt       DateTime     @map("due_at")
  returnedAt  DateTime?    @map("returned_at")
  status      BorrowStatus @default(active)
  
  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  book        Book         @relation(fields: [bookId], references: [id], onDelete: Cascade)
  
  @@map("borrows")
  @@index([userId])
  @@index([bookId])
  @@index([status, dueAt])
  @@index([borrowedAt(sort: Desc)])
}

model Interaction {
  id        String          @id @default(uuid())
  userId    String          @map("user_id")
  bookId    String          @map("book_id")
  type      InteractionType
  content   String?
  createdAt DateTime        @default(now()) @map("created_at")
  
  // Relations
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  book      Book            @relation(fields: [bookId], references: [id], onDelete: Cascade)
  
  @@map("interactions")
  @@index([bookId, type])
  @@index([userId, createdAt(sort: Desc)])
  @@unique([userId, bookId, type])
}

model PointTransaction {
  id        String       @id @default(uuid())
  userId    String       @map("user_id")
  delta     Int          // Positive for earning, negative for spending
  reason    PointReason
  refType   String?      @map("ref_type") // 'borrow_id', 'interaction_id', 'reward_id'
  refId     String?      @map("ref_id")   // UUID reference
  note      String?
  createdAt DateTime     @default(now()) @map("created_at")
  
  // Relations
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("point_transactions")
  @@index([userId, createdAt(sort: Desc)])
  @@index([reason])
}

model Reward {
  id          String   @id @default(uuid())
  name        String
  description String?
  costPoints  Int      @map("cost_points")
  stock       Int      @default(0)
  active      Boolean  @default(true)
  
  // Relations
  redeems     Redeem[]
  activities  Activity[]
  
  @@map("rewards")
  @@index([active])
}

model Redeem {
  id          String       @id @default(uuid())
  userId      String       @map("user_id")
  rewardId    String       @map("reward_id")
  costPoints  Int          @map("cost_points")
  status      RedeemStatus @default(pending)
  note        String?
  createdAt   DateTime     @default(now()) @map("created_at")
  
  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  reward      Reward       @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  
  @@map("redeems")
  @@index([userId, createdAt(sort: Desc)])
  @@index([status, createdAt(sort: Desc)])
}

model Activity {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  eventType EventType @map("event_type")
  bookId    String?   @map("book_id")
  rewardId  String?   @map("reward_id")
  payload   Json?     // Small JSON for additional data
  createdAt DateTime  @default(now()) @map("created_at")
  
  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  book      Book?     @relation(fields: [bookId], references: [id], onDelete: SetNull)
  reward    Reward?   @relation(fields: [rewardId], references: [id], onDelete: SetNull)
  
  @@map("activities")
  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([eventType, createdAt(sort: Desc)])
}
